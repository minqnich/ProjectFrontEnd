<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Category Management</title>
    <style>
      @import url("http://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap");

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}

body{
  min-height: 100vh;
  padding-bottom: 8%;
  background: rgb(3,2,18);
  background: linear-gradient(180deg, rgba(3,2,18,1) 0%, rgba(6,43,157,1) 100%);
  background-size: cover;
  background-position: center;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px 100px;
  background-color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
}



.logo {
  font-size: 32px;
  color: black;
  text-decoration: none;
  font-weight: 700;
}

.navbar a {
  position: relative;
  font-size: 18px;
  color: black;
  font-weight: 500;
  text-decoration: none;
  margin-left: 40px;
}

.navbar a::before {
  content: '';
  position: absolute;
  top: 100%;
  left: 0;
  width: 0;
  height: 2px;
  background: #fff;
  transition: .3s;
}

.navbar a:hover:before {
  width: 100%;
}

.qty_label {
  position: absolute;
  top: -2px;
  right: 80px;
  color: red;
  padding: 02px 7px;
  display: none;
}

/* info */

.headline {
  color: white;
  margin-top: 140px;
  margin-left: 120px;
  font-size: 30px;
}

.headline-product {
  position: relative;
  margin-top: 20%; /* ปรับตำแหน่งลงมาตามที่ต้องการ */
}

.headline-container {
  display: flex;
  align-items: center;
}

.headline-container button {
  margin-top: 130px;
  margin-left: 20px;
  font-size: 30px;
  padding: 5px 15px;
  background-color: white;
  color: black;
  border: none;
  border-radius: 50%;
  cursor: pointer;
}

.headline-container button:hover {
  background-color: #0056b3;
}

.headline-product{
  color: white;
  margin-top: 30px;
  margin-left: 120px;
  margin-bottom: 30px;
  font-size: 24px;

}
.row {
  position: relative;
}

.btn-group {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
}

.edit-button,
.delete-button {
  display: none;
}

.col:hover .edit-button,
.col:hover .delete-button {
  display: inline-block;
}


.btn {
  margin: 5px;
}

.btn{
  margin-top: 25px;
  font-size: 20px;
}

.text-product{
  color: white;
  margin-top: 15px;
  margin-left: 120px;
  margin-bottom: 90px;
  font-size: 24px;
}

.product-container {
  display: flex;
  align-items: center;
  color: #000;
}

.product-container button{
  margin-top: 5px;
  margin-left: 20px;
}

.add-button{
  display: flex;
  align-items: center;
  margin-top: 100px;
  margin-left: 20px;
  font-size: 30px;
  padding: 5px 15px;
  background-color: white;
  color: black;
  border: none;
  border-radius: 50%;
  cursor: pointer;
}


img.item{
  width: 300px;
  height:300px
}


    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

<!-- Bootstrap JavaScript Bundle (Bootstrap JS และ Popper.js) -->

  </head>

  <body>
    <header class="header">
      <a href="#" class="logo"
        ><img src="img/PS5.png" alt="logo" width="150" height="50"
      /></a>
      <nav class="navbar">
        <div class="dropdown">
          <a
            class="dropdown-toggle"
            href="#"
            role="button"
            id="dropdownMenuLink"
            data-bs-toggle="dropdown"
          >
            ADMIN
          </a>

          <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
            <li><a class="dropdown-item" href="#">Category Management</a></li>
            <li>
              <a class="dropdown-item" href="/productCategory"
                >Product Management</a
              >
            </li>
            <li>
              <a class="dropdown-item" href="/saleHistory"
                >Sales History</a
              >
            </li>
          </ul>
        </div>
        <a href="/login">LOG OUT</a>
      </nav>
    </header>

    <!-- headline -->
    <div class="headline-container">
      <h1 class="headline fw-bold">Category Management</h1>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal">+</button>
  </div>




  <!-- Bootstrap Modal for Adding Category -->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCategoryForm">
            <div class="mb-3">
              <label for="addCategoryName" class="form-label">Category Name</label>
              <input type="text" class="form-control" id="addCategoryName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="addCategoryBtn">Add Category</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Category List -->
  <div id="categoryList"></div>

<!-- Bootstrap Modal for Editing Category -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCategoryForm">
          <div class="mb-3">
            <label for="editCategoryName" class="form-label">Category Name</label>
            <input type="text" class="form-control" id="editCategoryName" required>
          </div>
          <input type="hidden" id="editId">
        </form>            
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveChanges">Save Changes</button>
      </div>        
    </div>
  </div>
</div>

    <!-- Bootstrap Modal for Deleting Category -->
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteCategoryModalLabel">Delete Category</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this category?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button class="btn btn-danger delete-btn" id="delete-btn">Delete</button>
            </div>          
          </div>
        </div>
      </div>
      
      <div class="container">
        <div class="text-white" style="padding-top: 50px;"> <!-- เพิ่ม padding-top เพื่อย้ายเนื้อหาลงมาบนหน้าจอ -->
          <% categories.forEach(category => { %>
            <h2 class="text-uppercase mb-4" style="color:  #fff; margin-top: 50px;"><%= category.category_name %></h2> <!-- เพิ่มสีข้อความเป็นสีขาว -->
            <div class="row row-cols-1 row-cols-md-3 g-4">
              <% products.filter(product => product.category_id === category.id).forEach(product => { %>
                <div class="col">
                  <div class="card border-0 shadow" style="background-color: #f8f9fa; height: 100%;"> <!-- เปลี่ยนสีพื้นหลังให้เป็นสีเทาอ่อนและกำหนดความสูงของ card เป็น 100% -->
                    <img style="width: 260px; height: 300px;" src="<%= product.product_images %>" class="card-img-top mx-auto d-block" alt="<%= product.product_name %>">
                    <div class="card-body">
                      <h5 class="card-title mb-3" style="color: #000;"><%= product.product_name %></h5> <!-- เปลี่ยนสีข้อความเป็นสีดำ -->
                      <p class="card-text text-muted mb-0">Price: $<%= product.product_price %></p> <!-- เพิ่ม text-muted เพื่อทำให้ข้อความเป็นสีเทาอ่อน และลบระยะห่างด้านล่าง -->
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% }); %>
        </div>
      </div>
      
    

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      <script>

        // for edit category
        function openEditModal(id, categoryName) {
          console.log('Opening edit modal for category:', id);
          console.log('Category ID:', id);
          console.log('Category Name:', categoryName);
    
          if (!id) {
            console.error('Invalid category ID:', id);
            return;
          }
    
          document.getElementById('editId').value = id;
          document.getElementById('editCategoryName').value = categoryName;
    
          const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
          modal.show();
        }
    
        $(document).ready(function() {
    $('#saveChanges').click(function() {
      saveChanges();
    });
  });

  function saveChanges() {
    const newName = $('#editCategoryName').val();
    const id = $('#editId').val();

    if (!id || isNaN(id)) {
      console.error('Invalid category ID:', id);
      return;
    }

    fetch(`/api/updateCategory/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ category_name: newName })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to update category');
      }
      console.log('Category updated successfully');
      $('#editCategoryModal').modal('hide');
      location.reload();
    })
    .catch(error => {
      console.error('Error updating category:', error);
    });
  }
  function openDeleteModal(id) {
  console.log('Received ID:', id); // Debugging
  $('#deleteCategoryModal').modal('show');
  $('#delete-btn').on('click', function() {
    console.log('Button clicked, ID:', id); // Debugging
    deleteCategory(id);
  });
}

// Function to add delete event listeners to delete buttons
function addDeleteEventListeners() {
  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function() {
      const id = this.dataset.id; // Get category ID from data-id attribute
      openDeleteModal(id);
    });
  });
}

// Function to delete category
function deleteCategory(id) {
  console.log('Attempting to delete category with ID:', id);
  fetch(`/api/deleteCategory/${id}`, {
    method: 'DELETE'
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to delete category');
      }
      console.log('Category deleted successfully');

      // Reload the page after successful deletion
      location.reload();
    })
    .catch(error => {
      console.error('Error deleting category:', error);
    });
}

  // Add event listener when DOM content is loaded
  document.addEventListener("DOMContentLoaded", function () {
    // Fetch categories from API
    fetch('/api/categories')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch categories');
        }
        return response.json();
      })
      .then(categories => {
        const categoryList = document.getElementById('categoryList');
        // Iterate through categories and create HTML elements
        categories.forEach(category => {
          const categoryContainer = document.createElement('div');
          categoryContainer.classList.add('product-container');
          categoryContainer.innerHTML = `
            <h2 class="headline-product fw-bolder">${category.category_name}</h2>
            <button class="btn btn-secondary edit-btn" data-id="${category.id}" data-category-name="${category.category_name}">Edit</button>
            <button class="btn btn-danger delete-btn" data-id="${category.id}">Delete</button>
          `;
          categoryList.appendChild(categoryContainer);
        });

        

        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.addEventListener('click', function() {
            const id = this.dataset.id;
            const categoryName = this.parentElement.querySelector('.headline-product').innerText;
            openEditModal(id, categoryName);
          });
        });

        // Add event listeners for delete buttons
        addDeleteEventListeners();

        // Add event listener for saveChanges button
        document.getElementById('saveChanges').addEventListener('click', saveChanges);
      })
      .catch(error => console.error('Error loading categories:', error));
  });
    
        document.getElementById('addCategoryBtn').addEventListener('click', function() {
          const categoryName = document.getElementById('addCategoryName').value;
          fetch('/api/addCategory', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ category_name: categoryName })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to add category');
            }
            window.location.reload();
          })
          .catch(error => {
            console.error('Error adding category:', error);
          });
        });

        
      </script>
      
  </body>
</html>

 

